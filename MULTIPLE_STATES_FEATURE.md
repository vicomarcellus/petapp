# Множественные записи состояния в течение дня

## Что изменилось

Добавлена возможность записывать состояние питомца несколько раз в день. Это позволяет отслеживать динамику состояния, особенно после приема лекарств.

**Важно:** Общее состояние за день автоматически вычисляется как среднее арифметическое всех записей состояния за этот день.

## Новая структура данных

### StateEntry (новая таблица)
```typescript
interface StateEntry {
  id?: number;
  userId: number;
  petId: number;
  date: string;        // YYYY-MM-DD
  time: string;        // HH:mm
  timestamp: number;   // для сортировки
  state_score: 1 | 2 | 3 | 4 | 5;
  note?: string;       // опциональная заметка
  created_at: number;
}
```

### DayEntry (обновлено)
- `state_score` теперь автоматически вычисляется как среднее из всех `StateEntry` за день
- Обновляется при добавлении/удалении записей состояния

## Возможности

1. **Добавление состояния с временем**
   - Нажмите "+ Добавить" в секции "Записи состояния"
   - Выберите оценку (1-5)
   - Укажите время
   - Добавьте заметку (опционально)
   - Среднее состояние дня обновится автоматически

2. **Просмотр среднего за день**
   - В верхней части экрана отображается карточка со средним состоянием
   - Показывает количество записей, из которых вычислено среднее

3. **Просмотр всех записей за день**
   - Все записи состояния отображаются в хронологическом порядке
   - Показывается время, оценка и заметка

4. **Удаление записи**
   - Наведите на запись состояния
   - Нажмите кнопку X
   - Среднее состояние дня пересчитается автоматически

5. **Календарь**
   - Цвет дня в календаре показывает среднюю оценку за день
   - В подсказке отображаются все записи состояния с временем

6. **Статистика**
   - Средняя оценка за месяц вычисляется из средних оценок дней
   - "Хорошие дни" - это дни со средней оценкой >= 4

## Автоматический расчет среднего

**Пример:**
- 09:00 - состояние 2/5 (плохо)
- 14:00 - состояние 4/5 (нормально, после лекарства)
- 20:00 - состояние 5/5 (отлично)

**Среднее за день:** (2 + 4 + 5) / 3 = 3.67 ≈ **4/5** (округляется)

Это среднее значение:
- Отображается в карточке "Среднее за день"
- Используется для цвета дня в календаре
- Учитывается в статистике и аналитике

## Миграция данных

При обновлении до версии 9 базы данных:
- Все существующие записи состояния из `dayEntries` автоматически мигрируют в `stateEntries`
- Старым записям присваивается время 12:00
- Данные не теряются
- `state_score` в `dayEntries` сохраняется для обратной совместимости

## Использование

**Типичный сценарий:**
1. Утро (09:00) - записываете состояние перед лекарством: 2/5
2. День (14:00) - записываете состояние после лекарства: 4/5
3. Вечер (20:00) - записываете состояние перед сном: 4/5
4. **Среднее за день:** 3.3 ≈ 3/5

Это позволяет видеть, как лекарства влияют на состояние питомца в течение дня, а среднее значение дает объективную оценку дня в целом.

## Технические детали

- Версия БД: 9
- Новая таблица: `stateEntries`
- Индексы: `userId`, `petId`, `date`, `timestamp`, `time`
- Обратная совместимость: сохранена таблица `dayEntries` для симптомов и заметок
- Функция `updateDayEntryAverage()` автоматически пересчитывает среднее при изменениях
