# 📎 Система множественных вложений

## Статус: ✅ Код готов, нужна настройка Supabase

Вся функциональность вложений реализована в коде. Осталось только настроить Supabase Storage.

## 🚀 Быстрый старт

### Если видишь ошибку "Bucket not found"

Открой файл **`QUICK_FIX_STORAGE.md`** - там пошаговая инструкция на 3 минуты.

### Если нужна диагностика

Открой файл **`TEST_STORAGE.md`** - там подробные тесты и проверки.

## 📋 Что уже сделано

### 1. База данных
- ✅ Таблица `attachments` для хранения метаданных файлов
- ✅ RLS политики для безопасности
- ✅ Индексы для быстрого поиска

### 2. Сервисы
- ✅ `src/services/storage.ts` - загрузка/удаление файлов
- ✅ `src/services/entryAttachments.ts` - работа с вложениями записей
- ✅ Автоматическое сжатие изображений (макс 1920px, качество 0.8)
- ✅ Валидация файлов (макс 10 MB)

### 3. Компоненты
- ✅ `FileUpload` - загрузка множественных файлов
- ✅ `AttachmentIcons` - отображение иконок в таймлайне
- ✅ `Modal` - автоматическое разделение на header/content/footer
- ✅ Компактные превью 24x24px

### 4. Хуки
- ✅ `useAttachments` - управление вложениями
- ✅ Загрузка существующих файлов
- ✅ Добавление новых файлов
- ✅ Удаление файлов

### 5. Интеграция
- ✅ EntryView - все 4 типа записей (состояние, симптом, лекарство, питание)
- ✅ Сохранение вложений при создании записи
- ✅ Загрузка вложений при редактировании
- ✅ Удаление вложений
- ✅ Иконки в таймлайне

## 🎯 Возможности

### Поддерживаемые форматы
- 🖼️ Изображения: JPEG, PNG, GIF, WebP
- 📄 Документы: PDF

### Ограничения
- Максимальный размер файла: **10 MB**
- Изображения автоматически сжимаются до **1920px** ширины
- Качество сжатия: **0.8** (80%)

### Функции
- ✅ Множественные файлы на одну запись
- ✅ Превью перед загрузкой
- ✅ Удаление файлов
- ✅ Редактирование записей с файлами
- ✅ Иконки в таймлайне для быстрого доступа
- ✅ Открытие файлов в новой вкладке

## 📁 Структура файлов

### Код
```
src/
├── components/
│   ├── AttachmentIcons.tsx      # Иконки файлов в таймлайне
│   ├── EntryView.tsx             # Интеграция с записями
│   └── ui/
│       ├── FileUpload.tsx        # Компонент загрузки
│       └── Modal.tsx             # Модальное окно
├── hooks/
│   └── useAttachments.ts         # Хук для работы с файлами
├── services/
│   ├── storage.ts                # Основной сервис Storage
│   └── entryAttachments.ts       # Вспомогательные функции
├── utils/
│   └── filePreview.ts            # Создание превью
└── types.ts                      # Типы (Attachment)
```

### SQL
```
sql/
├── create_attachments_table.sql  # Таблица для метаданных
└── create_storage_bucket.sql     # Политики для Storage
```

### Документация
```
QUICK_FIX_STORAGE.md             # Быстрая настройка (3 мин)
TEST_STORAGE.md                  # Диагностика и тесты
SETUP_STORAGE.md                 # Подробная инструкция
```

## 🔧 Архитектура

```
┌─────────────────────────────────────────────────────────┐
│                    Supabase Storage                      │
│                   (bucket: attachments)                  │
│                                                          │
│  /{user_id}/{pet_id}/{category}/{item_id}/{file}       │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                  Таблица: attachments                    │
│                                                          │
│  id, user_id, pet_id, parent_type, parent_id,          │
│  file_url, file_type, file_name, file_size             │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                  useAttachments Hook                     │
│                                                          │
│  loadEntryAttachments, addFiles, removeFile,            │
│  uploadNewFiles, removeAttachment                       │
└─────────────────────────────────────────────────────────┘
                            ↕
┌─────────────────────────────────────────────────────────┐
│                   UI Components                          │
│                                                          │
│  FileUpload (загрузка) + AttachmentIcons (отображение)  │
└─────────────────────────────────────────────────────────┘
```

## 🧪 Как тестировать

1. **Создание записи с файлами**
   - Открой EntryView
   - Создай новую запись (любого типа)
   - Нажми "Добавить файлы"
   - Выбери 2-3 картинки
   - Сохрани
   - Проверь что иконки появились в таймлайне

2. **Просмотр файлов**
   - Кликни на иконку файла
   - Файл должен открыться в новой вкладке

3. **Редактирование**
   - Открой запись на редактирование
   - Добавь ещё один файл
   - Удали один из существующих
   - Сохрани
   - Проверь что изменения применились

4. **Разные типы файлов**
   - Загрузи картинку (JPEG/PNG) - должна быть синяя иконка
   - Загрузи PDF - должна быть красная иконка
   - Проверь что оба типа открываются

## 🐛 Решение проблем

### "Bucket not found"
→ Bucket не создан в Supabase Storage
→ Открой `QUICK_FIX_STORAGE.md` → ШАГ 1

### "Object not found"
→ Bucket не публичный
→ Storage → attachments → Settings → Public bucket: ✅

### "Permission denied"
→ RLS политики неправильные
→ Открой `QUICK_FIX_STORAGE.md` → ШАГ 2

### Файл не загружается
→ Проверь размер (макс 10 MB)
→ Проверь формат (только изображения и PDF)
→ Открой консоль браузера (F12) и посмотри ошибку

### Иконки не появляются
→ Проверь что таблица `attachments` создана
→ Открой `QUICK_FIX_STORAGE.md` → ШАГ 3

## 📝 Примеры использования

### В компоненте
```tsx
const { 
  attachments,      // Существующие файлы
  newFiles,         // Новые файлы для загрузки
  addFiles,         // Добавить файлы
  removeNewFile,    // Удалить новый файл
  removeAttachment, // Удалить существующий
  uploadNewFiles,   // Загрузить все новые
  reset            // Очистить состояние
} = useAttachments(userId, petId);

// При сохранении записи
const savedAttachments = await uploadNewFiles('state', entryId, 'entry');
```

### В модалке
```tsx
<FileUpload
  onFilesSelect={async (files) => {
    addFiles(files);
    const previews = await createFilePreviews(files);
    setFilePreviews(prev => [...prev, ...previews]);
  }}
  currentAttachments={attachments}
  newFiles={filePreviews}
  onRemoveAttachment={removeAttachment}
  onRemoveNewFile={(index) => {
    removeNewFile(index);
    setFilePreviews(prev => prev.filter((_, i) => i !== index));
  }}
/>
```

### В таймлайне
```tsx
<AttachmentIcons 
  attachments={entryAttachments.get(`state-${entry.id}`) || []} 
  size="sm" 
/>
```

## ✅ Чеклист готовности

- [x] Таблица `attachments` создана
- [x] Типы определены в `types.ts`
- [x] Сервисы реализованы
- [x] Хук `useAttachments` создан
- [x] Компоненты `FileUpload` и `AttachmentIcons` готовы
- [x] Интеграция с `EntryView` завершена
- [x] Модалка поддерживает скролл контента
- [x] Превью компактные (24x24px)
- [ ] **Bucket `attachments` создан в Supabase** ← СДЕЛАЙ ЭТО
- [ ] **RLS политики настроены** ← И ЭТО
- [ ] Протестировано на реальных данных

## 🎉 Готово!

После настройки Supabase (файл `QUICK_FIX_STORAGE.md`) всё будет работать.
