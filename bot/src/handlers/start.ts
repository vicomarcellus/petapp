import { Context } from 'grammy';
import { mainMenuKeyboard } from '../keyboards.js';
import { getSupabaseUserId, getActivePet } from '../db.js';

export async function handleStart(ctx: Context) {
  const telegramId = ctx.from?.id;
  if (!telegramId) return;

  const userId = await getSupabaseUserId(telegramId);

  if (!userId) {
    await ctx.reply(
      'üëã –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è –ø–∏—Ç–æ–º—Ü–µ–≤.\n\n' +
      'üîó –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω—É–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç.\n\n' +
      '–û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí Telegram Bot, ' +
      '—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø—Ä–∏–≤—è–∑–∫–∏.\n\n' +
      '–ó–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –º–Ω–µ –∫–æ–º–∞–Ω–¥—É:\n' +
      '/link <–∫–æ–¥>'
    );
    return;
  }

  const pet = await getActivePet(userId);
  const petInfo = pet ? `\nüêæ –ê–∫—Ç–∏–≤–Ω—ã–π –ø–∏—Ç–æ–º–µ—Ü: ${pet.name}` : '\n‚ö†Ô∏è –£ –≤–∞—Å –Ω–µ—Ç –ø–∏—Ç–æ–º—Ü–µ–≤';

  await ctx.reply(
    `üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º!${petInfo}\n\n` +
    '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
    { reply_markup: mainMenuKeyboard() }
  );
}

export async function handleHelp(ctx: Context) {
  await ctx.reply(
    'üìñ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É*\n\n' +
    '*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n' +
    '/start - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n' +
    '/today - –ó–∞–ø–∏—Å–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è\n' +
    '/link <–∫–æ–¥> - –ü—Ä–∏–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç\n' +
    '/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n\n' +
    '*–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:*\n' +
    '‚Ä¢ üìä –°–µ–≥–æ–¥–Ω—è - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏\n' +
    '‚Ä¢ ‚ûï –î–æ–±–∞–≤–∏—Ç—å - —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å\n' +
    '‚Ä¢ üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è - –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è\n' +
    '‚Ä¢ üêæ –ü–∏—Ç–æ–º—Ü—ã - –≤—ã–±—Ä–∞—Ç—å –ø–∏—Ç–æ–º—Ü–∞\n\n' +
    '*–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π:*\n' +
    '1. –ù–∞–∂–º–∏—Ç–µ "‚ûï –î–æ–±–∞–≤–∏—Ç—å"\n' +
    '2. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–∞–ø–∏—Å–∏\n' +
    '3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º\n\n' +
    '–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é, ' +
    '–∏ –æ–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–æ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏.',
    { parse_mode: 'Markdown' }
  );
}
